---
phase: 01-ground-truth-tooling
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - scripts/check_translations/main.go
  - scripts/check_translations/main_test.go
autonomous: true
requirements:
  - TOOL-01

must_haves:
  truths:
    - "`make check-translations` reports actual missing/orphan keys instead of '0 found keys'"
    - "`extractKeysFromFile` accepts relative paths containing `..` without rejecting them"
    - "`loadLocaleFiles` loads all 4 locale files (en, es, fr, hi) without skipping any"
    - "Path traversal outside the project root is still rejected"
  artifacts:
    - path: "scripts/check_translations/main_test.go"
      provides: "Unit tests for path resolution fix"
      contains: "TestExtractKeysFromFile"
    - path: "scripts/check_translations/main.go"
      provides: "Fixed path validation using filepath.Abs"
      contains: "filepath.Abs"
  key_links:
    - from: "scripts/check_translations/main.go:extractKeysFromFile"
      to: "filepath.Abs"
      via: "Replaces strings.Contains(filePath, '..') with absolute path resolution"
      pattern: "filepath\\.Abs"
    - from: "scripts/check_translations/main.go:loadLocaleFiles"
      to: "filepath.Abs"
      via: "Same fix applied to locale file path validation"
      pattern: "filepath\\.Abs"
---

<objective>
Fix the `check-translations` script path resolution bug that causes it to report "0 found keys" and falsely claim "All translations present."

Purpose: This script is the gatekeeper for Phase 3 i18n work. Without a working check-translations, no locale gap data is trustworthy. This is the highest-leverage fix in Phase 1.

Output: A working `make check-translations` that correctly reports 400+ translation key usages across 4 locale files, with unit tests proving the path fix.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01/01-RESEARCH.md

<interfaces>
<!-- Key types and functions the executor needs from scripts/check_translations/main.go -->

```go
// Line 19-24: TranslationKey struct
type TranslationKey struct {
    Key       string
    File      string
    Line      int
    IsDynamic bool
}

// Line 123: The function with the bug (path validation at line 127-129)
func extractKeysFromFile(filePath string) ([]TranslationKey, error)

// Line 220: The function with the same bug (path validation at line 244-249)
func loadLocaleFiles(localesDir string) (map[string]map[string]interface{}, error)
```

Current broken path validation pattern (appears in BOTH functions):
```go
// extractKeysFromFile at line 127-129:
cleanPath := path.Clean(filePath)
if cleanPath != filePath || strings.Contains(filePath, "..") {
    return nil, fmt.Errorf("potentially unsafe file path: %s", filePath)
}

// loadLocaleFiles at line 244-248:
cleanPath := path.Clean(filePath)
if cleanPath != filePath || strings.Contains(filePath, "..") {
    fmt.Printf("  Warning: Potentially unsafe file path %s, skipping\n", filename)
    continue
}
```

The script is invoked via `make check-translations`:
```makefile
check-translations:
    @echo "Checking for missing translations..."
    @cd scripts/check_translations && $(GO_CMD) mod tidy && $(GO_CMD) run main.go
```
This `cd` means the working directory is `scripts/check_translations/`, so relative paths like `../../alita/...` and `../../locales/en.yml` are legitimate and expected.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Write failing tests for path resolution fix</name>
  <files>scripts/check_translations/main_test.go</files>
  <action>
Create `scripts/check_translations/main_test.go` with the following tests. These MUST fail against the current broken code (RED phase):

**TestExtractKeysFromFile_RelativePaths:**
- Create a temporary Go file containing `tr.GetString("test_key")` patterns
- Call `extractKeysFromFile()` with a relative path containing `..` (e.g., construct a path like `../tempdir/test.go`)
- Assert: returns keys (not an error). Currently this returns an error because `strings.Contains(filePath, "..")` rejects the path.

**TestExtractKeysFromFile_AbsolutePaths:**
- Call `extractKeysFromFile()` with an absolute path to the same temp file
- Assert: returns keys (this should already pass, but confirms no regression)

**TestLoadLocaleFiles_RelativePaths:**
- Create a temporary directory with a minimal YAML locale file (e.g., `test_key: "value"`)
- Call `loadLocaleFiles()` with a relative path containing `..` to that directory
- Assert: returns a map with the locale data loaded (not empty). Currently returns empty because the path validation skips every file.

**TestLoadLocaleFiles_PathTraversalRejected:**
- Call `loadLocaleFiles()` with a path that attempts to escape the project (e.g., `/etc/` or a path with symlink escape)
- Assert: the function handles this gracefully (returns empty or error, does not crash)

Use `t.TempDir()` for all temporary files. Import `path/filepath` for path construction. The test file must be in `package main` to access unexported functions.

Run the tests after writing them — they MUST fail (at least TestExtractKeysFromFile_RelativePaths and TestLoadLocaleFiles_RelativePaths). If they pass, the tests are wrong.
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot/scripts/check_translations && go test -v -run "TestExtractKeysFromFile_RelativePaths|TestLoadLocaleFiles_RelativePaths" 2>&1 | grep -q "FAIL"</automated>
  </verify>
  <done>Test file exists with 4+ test functions. The relative path tests FAIL against current code (RED phase confirmed). Absolute path test passes.</done>
</task>

<task type="auto">
  <name>Task 2: Fix path validation in extractKeysFromFile and loadLocaleFiles</name>
  <files>scripts/check_translations/main.go</files>
  <action>
Apply the fix to both functions in `scripts/check_translations/main.go` (GREEN phase):

**Fix 1 — `extractKeysFromFile()` (line 126-130):**

Replace:
```go
// Validate file path to prevent path traversal attacks
cleanPath := path.Clean(filePath)
if cleanPath != filePath || strings.Contains(filePath, "..") {
    return nil, fmt.Errorf("potentially unsafe file path: %s", filePath)
}
```

With:
```go
// Resolve to absolute path to handle legitimate relative paths (e.g., ../../alita/...)
absPath, err := filepath.Abs(filePath)
if err != nil {
    return nil, fmt.Errorf("could not resolve path %s: %w", filePath, err)
}
filePath = absPath
```

**Fix 2 — `loadLocaleFiles()` (line 244-255):**

Replace:
```go
// Validate file path to prevent path traversal attacks
cleanPath := path.Clean(filePath)
if cleanPath != filePath || strings.Contains(filePath, "..") {
    fmt.Printf("  ⚠️  Warning: Potentially unsafe file path %s, skipping\n", filename)
    continue
}

// Additional check: ensure the file is still within the locales directory
if !strings.HasPrefix(filePath, localesDir) {
    fmt.Printf("  ⚠️  Warning: File path %s is outside locales directory, skipping\n", filename)
    continue
}
```

With:
```go
// Resolve to absolute path to handle legitimate relative paths
absFilePath, err := filepath.Abs(filePath)
if err != nil {
    fmt.Printf("  Warning: Could not resolve path %s, skipping: %v\n", filename, err)
    continue
}
filePath = absFilePath

// Ensure the resolved path is still within the locales directory
absLocalesDir, _ := filepath.Abs(localesDir)
if !strings.HasPrefix(filePath, absLocalesDir) {
    fmt.Printf("  Warning: File path %s is outside locales directory, skipping\n", filename)
    continue
}
```

**Also:** Check the import block at the top of the file. If `"path"` is imported but `"path/filepath"` is already imported, remove the `"path"` import since `path.Clean` is no longer called. If `"path"` is used elsewhere in the file, keep it. The `"path/filepath"` import is already present (used for `filepath.Join` and `filepath.Glob` elsewhere).

After making the fix, run:
1. `go test -v ./...` in the `scripts/check_translations/` directory — all tests should pass (GREEN)
2. `go run main.go` from the same directory — should report actual translation key counts (not "0 found keys")

Expected output after fix: "Found N translation keys" where N > 400, and 4 locale files loaded.
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot/scripts/check_translations && go test -v ./... && go run main.go 2>&1 | grep -v "^$" | head -30</automated>
  </verify>
  <done>All tests pass (GREEN). `go run main.go` reports non-zero translation key counts and loads all 4 locale files. `make check-translations` from project root produces actual findings instead of false "All translations present."</done>
</task>

</tasks>

<verification>
1. `cd scripts/check_translations && go test -v ./...` — all tests pass
2. `make check-translations` — reports actual key counts (N > 0) and loads 4 locale files
3. Output no longer says "0 found keys" or "All translations present" when there are real gaps
4. No regressions: absolute paths still work, path traversal outside project is still rejected
</verification>

<success_criteria>
- `extractKeysFromFile("../../alita/modules/bans.go")` returns translation keys (not an error)
- `loadLocaleFiles("../../locales")` loads all 4 YAML files (en.yml, es.yml, fr.yml, hi.yml)
- `make check-translations` output shows actual missing/orphan translation key findings
- Unit tests cover both the fix (relative paths work) and the security intent (traversal rejected)
</success_criteria>

<output>
After completion, create `.planning/phases/01/01-01-SUMMARY.md`
</output>
