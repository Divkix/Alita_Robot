# Stack Research

**Domain:** Go Telegram bot — documentation audit, command consistency, i18n verification
**Researched:** 2026-02-27
**Confidence:** HIGH (tools verified against official docs and current sources)

---

## Context: What Already Exists

Before recommending anything, the codebase already has two custom Go scripts that cover significant ground:

- **`scripts/generate_docs/`** — Regex-based parser that extracts `handlers.NewCommand(...)` calls, `misc.AddCmdToDisableable(...)` registrations, env vars from `config.go`, DB tables from migrations, callbacks, and permission functions. Generates Astro/Starlight MDX. Invoked via `make generate-docs`.
- **`scripts/check_translations/`** — AST-based (`go/ast`) tool that extracts `tr.GetString(...)` and `tr.GetStringSlice(...)` calls across all Go files, then diffs against all locale YAML files. Invoked via `make check-translations`.

The gap is not that tools don't exist — it's that the existing tools have specific blindspots. Recommendations below address those gaps directly.

---

## Recommended Stack

### Core Technologies (Existing — Do Not Replace)

| Technology | Version | Purpose | Why Keep It |
|------------|---------|---------|-------------|
| Go standard `go/ast` + `go/parser` | stdlib | AST traversal for command/translation extraction | Already integrated in `check_translations` script. Zero external deps. Full type information available. |
| `regexp` (stdlib) | stdlib | Pattern matching for command registration extraction in `generate_docs` | Already works for `handlers.NewCommand(...)` pattern. Covers 138 registrations. |
| `gopkg.in/yaml.v3` | v3.0.1 | YAML parsing in both scripts | Already a project dependency. Consistent with the locale loading in the bot itself. |
| Astro/Starlight | v5.17.3 / v0.37.6 | Docs site rendering | Locked in. No reason to change. |
| `make` | system | Orchestrates all audit commands | Already has `check-translations`, `generate-docs`. Add new audit targets here. |

### Gap-Filling Tools

#### 1. `starlight-links-validator` — Internal link validation for the docs site

**Source:** [HiDeoo/starlight-links-validator](https://github.com/HiDeoo/starlight-links-validator) — latest release December 1, 2025 (MEDIUM confidence, verified via npm and GitHub)

**What it does:** Validates all internal Markdown/MDX links in the Starlight docs site at build time. Catches broken `[text](../other-page)` links and invalid hash anchors before deployment to Cloudflare Workers.

**Why use it:** The docs site is generated by `make generate-docs` and then deployed. Without link validation, a regenerated page can silently break cross-references. The plugin runs during `astro build` — no separate CI step required.

**Install:**
```bash
cd docs && bun add starlight-links-validator
```

**Config in `docs/astro.config.mjs`:**
```js
import starlightLinksValidator from 'starlight-links-validator'
// ...
plugins: [starlightThemeBlack({}), starlightLlmsTxt(), starlightLinksValidator()]
```

**Confidence:** MEDIUM — official Starlight plugin registry lists it, npm shows active maintenance, confirmed no compatibility issues with Starlight v0.37.x.

---

#### 2. `dyff` — Structural YAML diff for locale completeness

**Source:** [homeport/dyff](https://github.com/homeport/dyff) — actively maintained, available via `brew install dyff`

**What it does:** Semantically diffs two YAML files and reports missing keys (not just line diffs). Better than `diff` because it understands YAML structure, handles nested keys, and reports by key path rather than line number.

**Why use it:** The existing `check_translations` script uses AST to find keys used in Go source, but it does not compare locale files against each other for structural completeness. The `hi.yml` locale is 403 lines shorter than `en.yml` — there are clearly missing keys that will silently fall back to English at runtime.

**Usage pattern:**
```bash
dyff between locales/en.yml locales/hi.yml
dyff between locales/en.yml locales/fr.yml
```

**Alternative:** Custom Go script (compare all locale YAMLs structurally). Build it if `dyff` output format is too noisy for CI. The project already has the `check_translations` script as a Go scaffold to extend.

**Confidence:** MEDIUM — tool verified as current and actively maintained. The specific use case (cross-locale structural diff) is the gap in the existing `check_translations` script.

---

#### 3. Extend `scripts/generate_docs/parsers.go` — Fix `cmdDecorator.MultiCommand` blindspot

**What the problem is:** The existing `parseCommands()` function matches only `handlers.NewCommand("cmd", ...)`. It uses the regex:
```go
newCommandPattern := regexp.MustCompile(`handlers\.NewCommand\s*\(\s*"([^"]+)"\s*,\s*(\w+)\.(\w+)\s*\)`)
```
It does NOT match `cmdDecorator.MultiCommand(dispatcher, []string{"remallbl", "rmallbl"}, ...)` calls. This means aliased commands (`resetrules`/`clearrules`, `privnote`/`privatenotes`, `markdownhelp`/`formatting`, `remallbl`/`rmallbl`) are invisible to the docs generator.

**Recommendation:** Add a second regex to `parseCommands()` in `scripts/generate_docs/parsers.go`:
```go
multiCmdPattern := regexp.MustCompile(`cmdDecorator\.MultiCommand\s*\(\s*\w+\s*,\s*\[\]string\s*\{([^}]+)\}\s*,\s*(\w+)\.(\w+)\s*\)`)
```
Extract the string list from the `[]string{...}` literal, split on commas, and register each as a command with `Aliases` populated.

**Why not switch to `go/ast`:** The existing script already works reliably with regex for the primary pattern. The MultiCommand case is structurally simple (literal string slice, no dynamic values). Adding a second regex is a 10-line change vs. a 100-line AST refactor with no practical benefit for this specific problem.

**Confidence:** HIGH — verified by reading `parsers.go` source and cross-referencing with actual `cmdDecorator.MultiCommand` callsites in the modules.

---

#### 4. `ast-grep` (sgr) — Ad-hoc structural code search during audit

**Source:** [ast-grep/ast-grep](https://github.com/ast-grep/ast-grep) — written in Rust, supports Go via tree-sitter, actively maintained

**What it does:** Structural code search using pattern syntax. `sg run --pattern 'handlers.NewCommand($CMD, $$$)' --lang go` extracts all command registrations as JSON. Can also find all `tr.GetString("$KEY")` calls quickly without writing a script.

**Why use it for audit work:** Not for CI — for one-off investigation during the audit phase. When you need to answer "show me every place where X is called with Y as first argument," ast-grep is faster than writing a Go analysis pass.

**Install:**
```bash
brew install ast-grep
```

**Caveat specific to Go:** A plain pattern like `fmt.Println($A)` may not parse correctly in Go with tree-sitter because Go function calls and type conversions are syntactically ambiguous. Wrap patterns in function context: `func t() { handlers.NewCommand($CMD, $$$) }`. This is a documented ast-grep limitation.

**Confidence:** MEDIUM — tool behavior verified against [ast-grep Go catalog](https://ast-grep.github.io/catalog/go/). The Go caveat is documented in their official FAQ.

---

#### 5. `golang.org/x/tools/go/analysis` framework — Only if regex approach breaks

**Source:** [pkg.go.dev/golang.org/x/tools/go/analysis](https://pkg.go.dev/golang.org/x/tools/go/analysis)

**What it does:** Official Go static analysis framework used by `gopls`, `go vet`, and all major linters. Provides type-checked AST access, package-level analysis, and result sharing between passes.

**When to reach for it:** If the command extraction needs to handle indirect registrations (e.g., a `LoadHandlers` function that loops over a slice), regex will fail and you need type-resolved call graph analysis. For this project's current pattern (direct `handlers.NewCommand("literal", ...)` calls), the analysis framework is overkill.

**Do not use it for:** Replacing the existing `go/ast` + regex approach in `check_translations`. The existing tool covers its job. Rewriting it with the analysis framework adds complexity without benefit.

**Confidence:** HIGH — official Go tooling, well-documented. The "when to use" judgment is based on reviewing the actual codebase patterns.

---

### Development Tools (Existing — Verify Config)

| Tool | Purpose | Notes |
|------|---------|-------|
| `golangci-lint` v2.9.0 | Lint audit scripts themselves | Already in Makefile. Run `make lint` against new scripts in `scripts/`. |
| `make` targets | Orchestrate all checks | Add `make check-docs` and `make check-locale-sync` as new targets. |
| `bun` | Docs site build | Used for `astro build` which runs `starlight-links-validator`. Already in use. |

---

## What NOT to Use

| Avoid | Why | Use Instead |
|-------|-----|-------------|
| `go-i18n` (nicksnyder) for key checking | This project uses a custom YAML locale format with `config.yml` as the key schema. Migrating to `go-i18n`'s message file format would require rewriting the locale manager singleton and all 4 locale YAML files. Not in scope. | The existing `check_translations` script + `dyff` for cross-locale comparison. |
| `i18n-linter` (toeirei/keymaster) | Hardcoded for `i18n.T()` call pattern. This project uses `tr.GetString()` and `tr.GetStringSlice()`. Would require forking or significant configuration. | Extend the existing `check_translations` script which already handles this project's exact call patterns. |
| Full `go/analysis` framework rewrite for command extraction | The current pattern is static — all command names are string literals. The analysis framework's type resolution adds no value for literal extraction. | `go/ast` + regex (already working). Add MultiCommand regex as described above. |
| `compare-yaml` (mosanden) or `yamldiff` (sahilm) | These tools do structural YAML diff but produce output optimized for human reading of config files, not for finding missing locale keys in CI. Output format is noisy for automation. | `dyff` (cleaner output) or a custom Go script extending the existing `check_translations` pattern. |
| External documentation testing platforms (e.g., Algolia DocSearch audit, Broken Link Checker cloud services) | No external service access needed. The Cloudflare Workers deployment is public but the value is in catching errors before deploy, not after. | `starlight-links-validator` runs at build time — no external service needed. |

---

## Alternatives Considered

| Recommended | Alternative | When to Use Alternative |
|-------------|-------------|-------------------------|
| Regex extension for `MultiCommand` in `parsers.go` | Full `go/ast` rewrite of `parseCommands()` | If command registration ever becomes dynamic (loop over slice, conditional registration). Not the case now. |
| `dyff` for locale cross-comparison | Extend `check_translations` Go script with cross-locale diff | If CI needs machine-readable JSON output of missing keys (e.g., for GitHub Actions annotations). Custom Go script is better for programmatic output. |
| `starlight-links-validator` Astro plugin | `lychee` or `htmltest` as post-build link checkers | If you need to also validate external links. `starlight-links-validator` only handles internal links. `lychee` handles both but adds a separate CI step. |

---

## Stack Patterns by Variant

**If locale comparison needs CI-machine-readable output (GitHub Actions):**
- Extend `scripts/check_translations/main.go` with a cross-locale comparison pass
- Output JSON with missing keys and their locations
- Exit code 1 on any missing key

**If the docs generator needs to handle dynamic command registration in the future:**
- Switch `parseCommands()` from regex to `go/ast`
- Use `ast.Inspect()` with `*ast.CallExpr` visitor
- Match on `Fun.(*ast.SelectorExpr).Sel.Name == "NewCommand"` and extract `Args[0].(*ast.BasicLit).Value`

**If the Astro docs site validation needs external link checking:**
- Add `lychee` as a separate CI step after `astro build`
- Configure with `--exclude-mail --exclude-loopback --timeout 10`

---

## Version Compatibility

| Package | Compatible With | Notes |
|---------|-----------------|-------|
| `starlight-links-validator` latest | Starlight v0.37.6 | Confirmed: plugin uses Starlight's Content Layer API. Cache invalidation behavior changed in Dec 2025 release — use conditional validation in CI to avoid unnecessary cache rebuilds. |
| `dyff` latest | YAML v1.1 + v1.2 | Handles gopkg.in/yaml.v3 output. No issues with the YAML subset this project uses. |
| `ast-grep` latest | Go 1.25+ / tree-sitter Go grammar | Go grammar supported. Apply function-context workaround for call expression patterns. |

---

## Sources

- [HiDeoo/starlight-links-validator GitHub](https://github.com/HiDeoo/starlight-links-validator) — plugin features, Dec 2025 release notes (MEDIUM confidence)
- [homeport/dyff GitHub](https://github.com/homeport/dyff) — YAML structural diff capabilities (MEDIUM confidence)
- [ast-grep Go catalog](https://ast-grep.github.io/catalog/go/) — Go pattern syntax, known limitations with type conversions (MEDIUM confidence)
- [pkg.go.dev/golang.org/x/tools/go/analysis](https://pkg.go.dev/golang.org/x/tools/go/analysis) — official analysis framework docs (HIGH confidence)
- [pkg.go.dev/go/ast](https://pkg.go.dev/go/ast) — stdlib AST package docs (HIGH confidence)
- Codebase inspection: `scripts/generate_docs/parsers.go`, `scripts/check_translations/main.go`, `alita/modules/*.go` — direct source review (HIGH confidence)
- Locale line count comparison: `en.yml` (2207 lines) vs `hi.yml` (1804 lines) — 403-line gap confirmed by direct measurement (HIGH confidence)
- Command registration count: 138 `handlers.NewCommand` + `cmdDecorator.MultiCommand` calls across 22 module files — direct grep (HIGH confidence)

---

*Stack research for: Alita Robot — documentation audit and command consistency*
*Researched: 2026-02-27*
