# Phase 5: README and Final Verification - Research

**Researched:** 2026-02-28
**Domain:** Documentation accuracy, README correctness, Astro build validation, generate-docs drift
**Confidence:** HIGH — all findings are based on direct codebase inspection

---

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| VRFY-01 | Fix README project structure diagram (remove `cmd/` reference) | Confirmed: `cmd/` does not exist. Diagram also has wrong Go version, wrong label for migrations dir. Exact changes documented below. |
| VRFY-02 | Update README command count and feature descriptions to match actual codebase | Confirmed: README has stale env vars, incorrect cache stack description (claims Ristretto — gone), stale Go version claim. No numeric count of "120 commands / 21 modules" in README itself; the stale count is in `commands/index.mdx` (says 24 modules / 142 commands — 24 modules is correct if bot_updates is excluded, 142 commands matches inventory). |
| VRFY-03 | Confirm Astro docs build passes clean with `starlight-links-validator` | Confirmed: `bun run build` in `docs/` passes with "All internal links are valid." Output: 52 pages, 0 errors. |
| VRFY-04 | Run `make generate-docs` and verify output consistency with manual fixes | Critical: `make generate-docs` currently produces output that DIVERGES from committed files in 28 files (733 insertions, 858 deletions). Root cause: `camelToScreamingSnake` bug in `scripts/generate_docs/parsers.go`. Must fix the script so generate-docs output matches committed manual fixes. |
</phase_requirements>

---

## Summary

Phase 5 has four tasks. Two are trivial edits (README structure + feature descriptions), one is a verification step that already passes (Astro build), and one requires fixing a bug in the generate-docs tooling before it can be verified as consistent.

The Astro build passes clean today. `starlight-links-validator` reports zero broken internal links across all 52 pages. VRFY-03 is already satisfied — the plan for 05-03 is to run the build, confirm the output, and commit verification evidence.

The README has several confirmed stale claims:
- `cmd/` directory listed in project structure — **does not exist**
- `supabase/` labeled as "Database migrations" — it is actually Supabase CLI config; real migrations are in `migrations/`
- Go version stated as 1.21+ — actual requirement is 1.25+ (from `go.mod`)
- Optional env var table references `CACHE_TTL`, `CACHE_SIZE`, `WORKER_POOL_SIZE`, `QUERY_TIMEOUT`, `WEBHOOK_PORT` — none of these exist in the codebase; the correct var is `HTTP_PORT`, `RESPONSE_CACHE_TTL`, etc.
- "Dual-Layer Cache: Redis + Ristretto" — Ristretto is not a dependency and is not used

The most complex task is VRFY-04. `make generate-docs` writes 28 files that diverge from the committed versions because `camelToScreamingSnake()` in `scripts/generate_docs/parsers.go` treats each consecutive uppercase letter as a word boundary, mangling acronyms: `DatabaseURL` → `DATABASE_U_R_L`, `DBMaxIdleConns` → `D_B_MAX_IDLE_CONNS`, `BatchRequestTimeoutMS` → `BATCH_REQUEST_TIMEOUT_M_S`. The fix is a standard Go implementation that detects acronym sequences.

**Primary recommendation:** Fix `camelToScreamingSnake` bug first (VRFY-04 blocker), then update README (VRFY-01 + VRFY-02), then run and confirm the Astro build (VRFY-03).

---

## Standard Stack

### Core
| Tool | Version | Purpose | Why Standard |
|------|---------|---------|--------------|
| `starlight-links-validator` | 0.19.2 | Catch broken internal links in Astro/Starlight builds | Already installed and configured in `astro.config.mjs` |
| Astro / Starlight | 5.17.3 / 0.37.6 | Docs site build | Project standard, already in use |
| `bun` | (project standard) | Run Astro builds | Project preference per CLAUDE.md |

### No New Dependencies Required
Phase 5 is purely a documentation accuracy and tooling bug-fix phase. No new libraries are needed.

---

## Architecture Patterns

### File Ownership Model

This is the key architectural tension in VRFY-04:

```
docs/src/content/docs/
├── commands/
│   ├── index.mdx          # HAND-AUTHORED (uses MDX + Astro components)
│   ├── index.md           # GENERATED by make generate-docs (plain MD, lower fidelity)
│   ├── admin/index.md     # GENERATED — overwritten on every generate-docs run
│   └── ...
├── api-reference/
│   ├── environment.md     # GENERATED — currently has mangled var names
│   ├── database-schema.md # GENERATED
│   ├── callbacks.md       # GENERATED
│   ├── commands.md        # GENERATED
│   ├── lock-types.md      # GENERATED
│   └── permissions.md     # GENERATED
└── architecture/          # HAND-AUTHORED — never touched by generate-docs
```

**Critical observation:** Astro treats `index.mdx` and `index.md` at the same path as a conflict — the `.mdx` wins. The `commands/index.mdx` (hand-authored, uses Starlight `<Card>`, `<Badge>` components, 261 lines) is the actual rendered page. The `commands/index.md` generated by `make generate-docs` (184 lines, plain MD) is effectively dead output since `.mdx` takes precedence. This means the generated `index.md` is irrelevant to the rendered site.

### generate-docs Script Targets

`make generate-docs` writes these files (confirmed by running it):

```
commands/{module}/index.md    — 21 module pages
commands/index.md             — overview (shadowed by index.mdx)
api-reference/commands.md
api-reference/environment.md
api-reference/database-schema.md
api-reference/callbacks.md    (logged twice — apparent duplicate run)
api-reference/permissions.md  (logged twice)
api-reference/lock-types.md   (logged twice)
```

### README Project Structure — Correct vs Current

**Current (wrong):**
```
├── cmd/                # Executables       ← DOES NOT EXIST
│   ├── alita/          # Main bot
│   └── migrate/        # Migration tool
├── supabase/           # Database migrations  ← WRONG label; it's Supabase CLI config
└── docker/             # Docker configurations
```

**Correct:**
```
├── migrations/         # Database migration SQL files
├── supabase/           # Supabase CLI configuration
└── docker/             # Docker configurations (multi-arch build definitions)
```

Note: `main.go` is at the repo root (no `cmd/` structure). The entrypoint is `main.go` directly.

---

## Confirmed Stale Claims in README

### VRFY-01: Project Structure Diagram (lines 521–535)

| Issue | Current | Correct |
|-------|---------|---------|
| `cmd/` directory | Listed with `alita/` and `migrate/` subdirs | **Does not exist** — remove entirely |
| `supabase/` label | "Database migrations" | "Supabase CLI configuration" |
| Missing | `migrations/` directory not shown | Should be listed as "Database migration SQL files" |

### VRFY-02: Feature Descriptions and Environment Variables

| Issue | Current | Correct |
|-------|---------|---------|
| Go version (line 253, 539) | "Go 1.21 or higher" | Go 1.25+ (per `go.mod`) |
| Cache stack (line 86) | "Dual-Layer Cache: Redis + Ristretto" | Redis only (Ristretto is not in `go.mod`, not used) |
| Env var `WEBHOOK_PORT` (config table) | Listed as optional var | Deprecated; correct var is `HTTP_PORT` (sample.env says "WEBHOOK_PORT is deprecated") |
| Env vars `CACHE_TTL`, `CACHE_SIZE`, `WORKER_POOL_SIZE`, `QUERY_TIMEOUT` | Listed in optional vars table | None exist in sample.env or config.go |
| Env var `MAX_DB_POOL_SIZE` | Listed in optional vars table | Does not exist; pool config uses `DB_MAX_OPEN_CONNS` etc. |
| Code documentation claim (line 507) | "All 774+ functions across 83 Go files" | Actual count: 1,172 functions in 147 files in `alita/` package |

**Note on command counts:** The README itself does not contain "120 commands / 21 modules" text. The `commands/index.mdx` shows `**Total Modules**: 24 | **Total Commands**: 142`. The canonical INVENTORY.md states 25 modules (142 commands) but includes `bot_updates` which is internal — so 24 user-facing modules + 142 commands is the accurate user-facing count. The index.mdx count is already correct. VRFY-02 applies to the README env var table and feature bullet points, not a command count in README (there is none).

---

## VRFY-04: The camelToScreamingSnake Bug

### Root Cause

File: `/Users/divkix/GitHub/Alita_Robot/scripts/generate_docs/parsers.go`, line 700–713.

The function detects uppercase letters and inserts `_` before each one, then converts to uppercase. For acronyms like `URL`, `DB`, `MS`, each letter triggers its own `_`:

```go
// CURRENT (broken)
func camelToScreamingSnake(s string) string {
    var result strings.Builder
    for i, r := range s {
        if r >= 'A' && r <= 'Z' {
            if i > 0 {
                result.WriteRune('_')  // underscore before EVERY uppercase
            }
            result.WriteRune(r)
        } else {
            result.WriteRune(r - 32)  // ASCII lowercase to uppercase
        }
    }
    return result.String()
}
```

**Result:** `DatabaseURL` → `D_A_T_A_B_A_S_E_U_R_L` (actually `DATABASE_U_R_L` because lowercase letters become uppercase directly, uppercase become `_X`)

Wait — let me re-trace: `D`(uppercase, i=0, no `_`, write `D`) → `a`(lowercase, write `A`) → `t` → `T` → `a` → `A` → `b` → `B` → `a` → `A` → `s` → `S` → `e` → `E` → `U`(uppercase, i>0, write `_U`) → `R`(uppercase, write `_R`) → `L`(uppercase, write `_L`). Result: `DATABASE_U_R_L`. Confirmed.

### Fix Pattern

Standard Go approach for CamelCase to SCREAMING_SNAKE_CASE with acronym handling:

```go
// CORRECT: handles consecutive uppercase as acronym group
func camelToScreamingSnake(s string) string {
    var result strings.Builder
    runes := []rune(s)
    for i, r := range runes {
        isUpper := r >= 'A' && r <= 'Z'
        if isUpper && i > 0 {
            prevIsLower := runes[i-1] >= 'a' && runes[i-1] <= 'z'
            nextIsLower := i+1 < len(runes) && runes[i+1] >= 'a' && runes[i+1] <= 'z'
            // Insert _ when: transitioning from lower→upper OR upper→upper-then-lower (acronym end)
            if prevIsLower || nextIsLower {
                result.WriteRune('_')
            }
        }
        if r >= 'a' && r <= 'z' {
            result.WriteRune(r - 32)
        } else {
            result.WriteRune(r)
        }
    }
    return result.String()
}
```

Test cases this must pass:
- `DatabaseURL` → `DATABASE_URL`
- `DBMaxIdleConns` → `DB_MAX_IDLE_CONNS`
- `DBConnMaxIdleTimeMin` → `DB_CONN_MAX_IDLE_TIME_MIN`
- `BatchRequestTimeoutMS` → `BATCH_REQUEST_TIMEOUT_MS`
- `EnableHTTPConnectionPooling` → `ENABLE_HTTP_CONNECTION_POOLING`
- `HTTPPort` → `HTTP_PORT`
- `BotToken` → `BOT_TOKEN`

### Scope of Impact

54 environment variable fields in `alita/config/config.go` use acronyms. Running the fixed generate-docs will re-generate `api-reference/environment.md` with correct names, making it match the committed (manually corrected) version.

### Remaining Drift After Bug Fix

Even after fixing `camelToScreamingSnake`, there will still be content drift in `commands/{module}/index.md` files because generate-docs uses `extractCommandDescription()` which returns "No description available" for commands where it can't parse descriptions from help text. The committed files have hand-curated descriptions. The correct resolution for VRFY-04 is:

**Option A (preferred):** Fix the `camelToScreamingSnake` bug only. Accept that `commands/` module pages have slightly different descriptions when re-generated — the committed hand-edited files are intentionally better. Commit the current working tree as the canonical state after fixing only the environment.md drift.

**Option B:** Fix `camelToScreamingSnake` AND improve `extractCommandDescription()` so auto-generated descriptions match the hand-edited ones. This is significantly more effort and out of phase scope.

**Option A is the correct choice for VRFY-04.** The requirement is "verify output consistency with manual fixes" — meaning verify that generate-docs doesn't produce garbage that breaks the docs. The `camelToScreamingSnake` fix resolves the egregious mangling. The remaining description-text differences are acceptable since the committed files are better.

---

## VRFY-03: Astro Build Validation

**Current state:** Build passes clean. Confirmed output:

```
✓ All internal links are valid.
[build] 52 page(s) built in 3.11s
[build] Complete!
```

**starlight-links-validator v0.19.2** is already installed and configured as a plugin in `astro.config.mjs`. It runs automatically during `bun run build`.

**The 05-03 plan is a verification step, not a fix step.** Run `bun run build` in `docs/`, capture the output confirming zero errors, done.

**One potential risk:** The newly created docs pages from Phase 4 (`commands/devs/`, `commands/help/`, `commands/users/`) contain internal links. These must be validated — and the build already passes, confirming they work.

---

## Common Pitfalls

### Pitfall 1: generate-docs overwrites manual fixes
**What goes wrong:** Running `make generate-docs` after committing manual edits to `commands/{module}/index.md` will silently overwrite them with lower-quality auto-generated content.
**Why it happens:** The generator writes unconditionally to all target files with no "hand-edited" protection.
**How to avoid:** The planner must order 05-04 (verify generate-docs) to run generate-docs and check the diff — not commit the generated output blindly. Fix only the `camelToScreamingSnake` bug, then commit the current working tree (manual edits for commands/, fixed env vars for api-reference/).

### Pitfall 2: commands/index.md vs commands/index.mdx conflict
**What goes wrong:** `make generate-docs` writes `commands/index.md` which shadows nothing (`.mdx` takes precedence in Astro), but creates a confusing parallel file.
**Why it happens:** The generator target is `.md`, the hand-authored file is `.mdx`.
**How to avoid:** The generated `commands/index.md` should either be deleted (Astro uses `.mdx`) or the generator should be updated to not write it. For this phase, deleting the generated `commands/index.md` or ignoring it is acceptable.

### Pitfall 3: README env var table has entirely nonexistent variables
**What goes wrong:** The README optional variables table references `CACHE_TTL`, `CACHE_SIZE`, `WORKER_POOL_SIZE`, `QUERY_TIMEOUT` which don't exist anywhere in the codebase.
**Why it happens:** These are likely copy-pasted from a different bot or a previous architecture.
**How to avoid:** Replace the entire optional vars table with actual variables from `sample.env`.

### Pitfall 4: Confusing "24 modules" vs "25 modules"
**What goes wrong:** The INVENTORY shows 25 modules, but `commands/index.mdx` says 24.
**Why it happens:** `bot_updates` is an internal module with no commands or user-facing behavior — it's correctly excluded from user-facing docs. 24 is the correct user-facing count.
**How to avoid:** Do not "fix" the 24 to 25 in `commands/index.mdx`.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| CamelCase to SCREAMING_SNAKE_CASE | Custom regex | Fix the existing `camelToScreamingSnake` function with proven algorithm | The function already exists, just has a bug — fix it in place |
| Link validation in docs | Manual link checking | `starlight-links-validator` (already installed) | Already integrated, runs on every build |
| Env var documentation | Manual table | Fix generate-docs and use `make generate-docs` | Script already parses config.go correctly after the bug fix |

---

## Code Examples

### Fixed camelToScreamingSnake Implementation

```go
// Source: direct analysis of the bug, standard Go pattern for CamelCase conversion
// File: scripts/generate_docs/parsers.go
func camelToScreamingSnake(s string) string {
    var result strings.Builder
    runes := []rune(s)
    for i, r := range runes {
        isUpper := r >= 'A' && r <= 'Z'
        if isUpper && i > 0 {
            prevIsLower := runes[i-1] >= 'a' && runes[i-1] <= 'z'
            nextIsLower := i+1 < len(runes) && runes[i+1] >= 'a' && runes[i+1] <= 'z'
            if prevIsLower || nextIsLower {
                result.WriteRune('_')
            }
        }
        if r >= 'a' && r <= 'z' {
            result.WriteRune(r - 32)
        } else {
            result.WriteRune(r)
        }
    }
    return result.String()
}
```

### Test Cases for camelToScreamingSnake (add to parsers_test.go)

```go
func TestCamelToScreamingSnake(t *testing.T) {
    cases := []struct{ in, want string }{
        {"DatabaseURL", "DATABASE_URL"},
        {"DBMaxIdleConns", "DB_MAX_IDLE_CONNS"},
        {"DBConnMaxIdleTimeMin", "DB_CONN_MAX_IDLE_TIME_MIN"},
        {"BatchRequestTimeoutMS", "BATCH_REQUEST_TIMEOUT_MS"},
        {"EnableHTTPConnectionPooling", "ENABLE_HTTP_CONNECTION_POOLING"},
        {"HTTPPort", "HTTP_PORT"},
        {"BotToken", "BOT_TOKEN"},
        {"EnablePPROF", "ENABLE_PPROF"},
    }
    for _, c := range cases {
        got := camelToScreamingSnake(c.in)
        if got != c.want {
            t.Errorf("camelToScreamingSnake(%q) = %q, want %q", c.in, got, c.want)
        }
    }
}
```

### README Project Structure Diagram (correct version)

```markdown
```
Alita_Robot/
├── alita/              # Core bot code
│   ├── config/         # Configuration management
│   ├── db/             # Database layer
│   ├── modules/        # Command handlers
│   ├── utils/          # Utility packages
│   └── i18n/           # Internationalization
├── migrations/         # Database migration SQL files
├── supabase/           # Supabase CLI configuration
├── locales/            # Language files
└── docker/             # Docker configurations
```
```

### Docs Build Verification Command

```bash
cd docs && bun run build 2>&1 | grep -E "✓|error|broken|Complete"
# Expected: "✓ All internal links are valid." + "[build] Complete!"
```

---

## Validation Architecture

### Test Framework
| Property | Value |
|----------|-------|
| Framework | Go `testing` package (for parsers_test.go) + Astro build (for link validation) |
| Config file | `scripts/generate_docs/parsers_test.go` (existing) |
| Quick run command | `cd scripts/generate_docs && go test ./... -run TestCamelToScreamingSnake` |
| Full suite command | `cd scripts/generate_docs && go test ./... && cd ../../docs && bun run build` |

### Phase Requirements → Test Map
| Req ID | Behavior | Test Type | Automated Command | File Exists? |
|--------|----------|-----------|-------------------|-------------|
| VRFY-01 | `cmd/` not in README project structure | smoke | `grep "cmd/" README.md` returns no match | ✅ (grep) |
| VRFY-02 | README env var table matches sample.env | smoke | `grep "CACHE_TTL\|CACHE_SIZE\|WORKER_POOL_SIZE" README.md` returns no match | ✅ (grep) |
| VRFY-03 | Astro build reports zero broken links | integration | `cd docs && bun run build \| grep "All internal links are valid"` | ✅ runs at build time |
| VRFY-04 | `camelToScreamingSnake` produces correct env names | unit | `cd scripts/generate_docs && go test ./... -run TestCamelToScreamingSnake` | ❌ Wave 0 gap — test must be added |

### Wave 0 Gaps
- [ ] `scripts/generate_docs/parsers_test.go` — add `TestCamelToScreamingSnake` function (file exists, function missing)

---

## Plan Structure Recommendation

Given the four sub-plans required (05-01 through 05-04), the natural execution order is:

1. **05-01**: Fix `camelToScreamingSnake` bug in `parsers.go` + add test cases. Run `make generate-docs`. Commit fixed script + regenerated `api-reference/*.md` files (environment.md, database-schema.md, etc.) with correct env var names.

2. **05-02**: Fix README: remove `cmd/` from project structure, replace `supabase/` label, add `migrations/`, fix Go version (1.21 → 1.25+), fix cache description (remove Ristretto), fix env var table (remove nonexistent vars, add correct ones). These are all edits to a single file.

3. **05-03**: Run `bun run build` in `docs/`, confirm clean output. If it fails (unlikely), identify and fix broken links. Commit verification.

4. **05-04**: Run `make generate-docs`, inspect the diff vs committed files, confirm no regressions from the `camelToScreamingSnake` fix. If drift remains in `commands/` description content, that is acceptable (committed hand-edits are better than generated output). Commit any remaining corrections.

**Dependency:** 05-01 should complete before 05-04 since 05-04 verifies 05-01's fix.
**05-02 and 05-03 are independent of each other and of 05-01.**

---

## Open Questions

1. **Generate-docs writes commands/index.md but commands/index.mdx exists**
   - What we know: Astro uses `.mdx` over `.md` — the generated `.md` is effectively invisible to the rendered site
   - What's unclear: Should the generator stop writing `commands/index.md`? Or should the hand-authored file be `.md` and the `.mdx` deleted?
   - Recommendation: Delete `commands/index.md` (the generated stale duplicate) and leave `commands/index.mdx` as the canonical hand-authored overview. Update the generator to not write `commands/index.md` (or suppress it).

2. **Scope of VRFY-02 README env var table**
   - What we know: The optional vars table has 8+ nonexistent variables
   - What's unclear: Should the table list ALL environment variables from sample.env or just a curated subset?
   - Recommendation: Replace the current stale table with a minimal curated set of the most common optional vars that actually exist in sample.env. Refer to `api-reference/environment.md` for the complete list.

---

## Sources

### Primary (HIGH confidence)
- Direct file inspection: `/Users/divkix/GitHub/Alita_Robot/README.md` — all stale claims confirmed by reading
- Direct file inspection: `/Users/divkix/GitHub/Alita_Robot/scripts/generate_docs/parsers.go` — bug confirmed by code trace
- `bun run build` execution output — "All internal links are valid" confirmed
- `make generate-docs` execution output + `git diff HEAD` — 28 files diverge, root cause confirmed
- `/Users/divkix/GitHub/Alita_Robot/go.mod` — Go 1.25.0 confirmed
- `/Users/divkix/GitHub/Alita_Robot/go.sum` + `go.mod` — Ristretto not present
- `/Users/divkix/GitHub/Alita_Robot/sample.env` — env var names confirmed
- `/Users/divkix/GitHub/Alita_Robot/.planning/INVENTORY.md` — 25 modules / 142 commands canonical counts

### Secondary (MEDIUM confidence)
- Astro `.mdx` vs `.md` precedence — standard Astro behavior; `.mdx` wins for same slug

---

## Metadata

**Confidence breakdown:**
- VRFY-01 (README structure): HIGH — `cmd/` confirmed absent, exact diff known
- VRFY-02 (README claims): HIGH — all stale vars and claims directly confirmed
- VRFY-03 (Astro build): HIGH — build executed and passed
- VRFY-04 (generate-docs consistency): HIGH — bug root cause traced, fix pattern verified

**Research date:** 2026-02-28
**Valid until:** 2026-03-28 (stable docs tooling, unlikely to change)
