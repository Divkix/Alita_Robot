---
phase: 04-operator-documentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/src/content/docs/architecture/handler-groups.md
  - docs/src/content/docs/architecture/request-flow.mdx
autonomous: true
requirements: [OPER-01]

must_haves:
  truths:
    - "A dedicated handler group precedence page exists in the architecture section of the docs site"
    - "The page contains a table with exact handler group numbers (-10, -2, -1, 0, 4, 5, 6, 7, 8, 9, 10) sourced from code"
    - "Each handler group entry documents the module name, handler function, filter, return behavior, and propagation effect"
    - "The inaccurate handler group tip in request-flow.mdx is corrected to link to the new authoritative page"
    - "The docs build passes clean with zero broken links"
  artifacts:
    - path: "docs/src/content/docs/architecture/handler-groups.md"
      provides: "Authoritative handler group precedence documentation"
      contains: "handlerGroup"
    - path: "docs/src/content/docs/architecture/request-flow.mdx"
      provides: "Corrected handler group tip with link to new page"
      contains: "/architecture/handler-groups"
  key_links:
    - from: "docs/src/content/docs/architecture/request-flow.mdx"
      to: "docs/src/content/docs/architecture/handler-groups.md"
      via: "Internal Starlight link in corrected tip"
      pattern: "/architecture/handler-groups"
---

<objective>
Create the authoritative handler group precedence documentation page and fix the inaccurate handler group tip in request-flow.mdx.

Purpose: Group admins and operators need to understand which message watchers fire first and how propagation works. The existing tip in request-flow.mdx has wrong group numbers (says antispam is in "negative groups" without specifying -2, and claims antiflood is negative when it is actually group 4). This plan replaces that inaccuracy with a dedicated, code-verified reference page.

Output: New `architecture/handler-groups.md` page with definitive precedence table; corrected tip in `request-flow.mdx` linking to the new page.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-operator-documentation/04-RESEARCH.md

Source files for handler group numbers (READ for verification, do NOT modify):
@alita/modules/antispam.go (group -2)
@alita/modules/captcha.go (group -10)
@alita/modules/users.go (group -1)
@alita/modules/antiflood.go (group 4)
@alita/modules/locks.go (groups 5, 6)
@alita/modules/blacklists.go (group 7)
@alita/modules/reports.go (group 8)
@alita/modules/filters.go (group 9)
@alita/modules/pins.go (group 10)

Existing docs file to update:
@docs/src/content/docs/architecture/request-flow.mdx (lines 269-273 have the inaccurate tip)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create handler-groups.md with definitive precedence table</name>
  <files>docs/src/content/docs/architecture/handler-groups.md</files>
  <action>
Create `docs/src/content/docs/architecture/handler-groups.md` with the following structure:

**Frontmatter:**
```yaml
---
title: Handler Group Precedence
description: Which message watchers fire first and how propagation works in Alita Robot.
---
```

**Content sections (in order):**

1. **Introduction paragraph** — Explain that gotgbot dispatches updates to handlers in ascending group number order. Lower group numbers fire first. Within the same group, handlers fire in registration order. A handler returning `ext.EndGroups` stops all further group processing. `ext.ContinueGroups` allows downstream groups to fire.

2. **Precedence Table** — Full Markdown table with these exact columns and rows, verified from code:

| Group | Module | Handler | Filter | Return on Match | Notes |
|-------|--------|---------|--------|-----------------|-------|
| -10 | Captcha | `handlePendingCaptchaMessage` | nil (all messages) | `EndGroups` | Intercepts messages from users with pending captcha; stores and deletes message |
| -2 | Antispam | (inline closure) | `message.All` | `EndGroups` | Rate-limits spamming users; passes through if not spamming |
| -1 | Users | `logUsers` | `message.All` | `ContinueGroups` | Logs user activity; never blocks propagation |
| 0 | All modules | Commands, callbacks | Various | varies | Default group; standard command handlers |
| 4 | Antiflood | `checkFlood` | `message.All` | `EndGroups` on flood, `ContinueGroups` otherwise | Flood control; skips anon admins and media groups |
| 5 | Locks | `permHandler` | `message.All` | `EndGroups` on violation | Permission-based locks (can_send_messages, etc.) |
| 6 | Locks | `restHandler` | `message.All` | `EndGroups` on violation | Restriction-based locks (stickers, animations, etc.) |
| 7 | Blacklists | `blacklistWatcher` | non-command, non-media-group | `ContinueGroups` (always) | Checks words against blacklist; action taken but processing continues |
| 8 | Reports | (handler) | `message.All` | varies | Report tracking |
| 9 | Filters | `filtersWatcher` | non-command, non-media-group | `ContinueGroups` (always) | Matches filter patterns; sends configured response but does not block |
| 10 | Pins | (handler) | `message.All` | `EndGroups` | Anti-channel-pin watcher |

3. **Propagation Behavior section** using `:::caution` admonition — Document these critical behaviors:
   - **Captcha is first (group -10):** Any message from a user with pending captcha is intercepted, stored for delivery after verification, and deleted. The message NEVER reaches antiflood, blacklists, or filters.
   - **Antispam EndGroups stops ALL further processing:** When antispam returns `EndGroups`, captcha-pending message storage, antiflood, locks, blacklists, and filters all stop. A rate-limited message never reaches any other watcher.
   - **Blacklists and Filters use ContinueGroups:** Both take their configured action (warn, mute, ban for blacklists; send reply for filters) but do NOT block downstream watchers. A message matching a blacklist word still gets checked by filters.

4. **Interaction Examples section** — Three short scenarios showing what happens:
   - Scenario 1: User with pending captcha sends a message → Captcha (group -10) intercepts, stores, deletes. Nothing else fires.
   - Scenario 2: User sends flood of messages → Antiflood (group 4) triggers after threshold. Commands in group 0 still fire for earlier messages. Locks, blacklists, filters for that message are blocked.
   - Scenario 3: User sends a message matching both a blacklist word and a filter → Locks (group 5/6) check first and pass. Blacklist (group 7) matches, takes action, continues. Filter (group 9) also matches, sends response.

5. **Related Pages section** — Links to:
   - [Request Flow](/architecture/request-flow) — Full update processing pipeline
   - [Module Pattern](/architecture/module-pattern) — How modules register handlers

Use plain Markdown with `:::caution` and `:::tip` admonitions. Do NOT use MDX imports (no Badge, Steps, etc.) — plain `.md` extension is correct.
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot/docs && bun run build 2>&1 | tail -20</automated>
  </verify>
  <done>handler-groups.md exists in architecture directory with the definitive 11-row precedence table, propagation behavior documentation, and interaction examples. Docs build passes.</done>
</task>

<task type="auto">
  <name>Task 2: Fix inaccurate handler group tip in request-flow.mdx</name>
  <files>docs/src/content/docs/architecture/request-flow.mdx</files>
  <action>
Replace the inaccurate tip block at lines 269-273 of `request-flow.mdx`:

**Current (WRONG):**
```
:::tip[Handler group conventions]
- **Negative groups (-1, -10)**: Early interception handlers (antispam, antiflood)
- **Group 0**: Standard command handlers (default)
- **Positive groups (4-10)**: Message watchers and monitors that should not block downstream processing
:::
```

**Replace with:**
```
:::tip[Handler group conventions]
- **Negative groups**: Early interception — captcha (-10), antispam (-2), user logging (-1)
- **Group 0**: Standard command handlers (default)
- **Positive groups (4-10)**: Message watchers — antiflood (4), locks (5-6), blacklists (7), reports (8), filters (9), pins (10)

For the complete precedence table with propagation behavior, see [Handler Group Precedence](/architecture/handler-groups).
:::
```

Key corrections:
1. Antispam is -2, NOT "-1 or -10" as implied
2. Antiflood is group 4 (positive), NOT negative as stated
3. Added link to the authoritative handler-groups page
4. Listed specific group numbers for each module
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot/docs && bun run build 2>&1 | tail -20</automated>
  </verify>
  <done>The handler group tip in request-flow.mdx has correct group numbers and links to the new handler-groups page. The internal link validates during docs build.</done>
</task>

</tasks>

<verification>
1. `cd docs && bun run build` passes with zero errors (starlight-links-validator confirms handler-groups link works)
2. `handler-groups.md` contains all 11 handler group rows (groups -10, -2, -1, 0, 4, 5, 6, 7, 8, 9, 10)
3. `request-flow.mdx` tip no longer claims antiflood is in negative groups
4. `request-flow.mdx` tip contains a link to `/architecture/handler-groups`
</verification>

<success_criteria>
- handler-groups.md exists at `docs/src/content/docs/architecture/handler-groups.md` with correct frontmatter
- The precedence table has exact group numbers verified against source code
- request-flow.mdx tip is corrected and links to handler-groups page
- `cd docs && bun run build` passes clean
</success_criteria>

<output>
After completion, create `.planning/phases/04-operator-documentation/04-01-SUMMARY.md`
</output>
