---
phase: 07-tech-debt-sentinel-guard-and-metadata-backfill
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - scripts/generate_docs/generators.go
  - scripts/generate_docs/generators_test.go
  - docs/src/content/docs/commands/admin/index.md
  - docs/src/content/docs/commands/antiflood/index.md
  - docs/src/content/docs/commands/antispam/index.md
  - docs/src/content/docs/commands/bans/index.md
  - docs/src/content/docs/commands/blacklists/index.md
  - docs/src/content/docs/commands/captcha/index.md
  - docs/src/content/docs/commands/connections/index.md
  - docs/src/content/docs/commands/disabling/index.md
  - docs/src/content/docs/commands/filters/index.md
  - docs/src/content/docs/commands/formatting/index.md
  - docs/src/content/docs/commands/greetings/index.md
  - docs/src/content/docs/commands/languages/index.md
  - docs/src/content/docs/commands/locks/index.md
  - docs/src/content/docs/commands/misc/index.md
  - docs/src/content/docs/commands/mutes/index.md
  - docs/src/content/docs/commands/notes/index.md
  - docs/src/content/docs/commands/pins/index.md
  - docs/src/content/docs/commands/purges/index.md
  - docs/src/content/docs/commands/reports/index.md
  - docs/src/content/docs/commands/rules/index.md
  - docs/src/content/docs/commands/warns/index.md
autonomous: true
requirements: []

must_haves:
  truths:
    - "generateModuleDocs() calls skipIfManuallyMaintained() before writing each module page"
    - "Sentinel-protected module pages are NOT overwritten by make generate-docs"
    - "Non-sentinel module pages ARE still written by make generate-docs"
    - "All 21 module pages contain the sentinel comment after YAML frontmatter"
    - "Working tree is clean for all 21 module pages after make generate-docs"
  artifacts:
    - path: "scripts/generate_docs/generators_test.go"
      provides: "Unit tests for sentinel skip in generateModuleDocs loop"
      contains: "TestGenerateModuleDocs_SkipsManuallyMaintainedFiles"
    - path: "scripts/generate_docs/generators.go"
      provides: "Sentinel guard inside generateModuleDocs for-loop"
      contains: "skipIfManuallyMaintained(moduleFile)"
  key_links:
    - from: "scripts/generate_docs/generators.go"
      to: "docs/src/content/docs/commands/*/index.md"
      via: "skipIfManuallyMaintained() check before os.WriteFile"
      pattern: "skipIfManuallyMaintained.*moduleFile"
---

<objective>
TDD-add sentinel guard to `generateModuleDocs()` so `make generate-docs` skips all 21 hand-crafted module pages, then restore those pages from git HEAD and insert sentinel comments.

Purpose: Every `make generate-docs` run currently overwrites hand-crafted alias blockquotes, normalized descriptions, and extended documentation in 21 module pages. This plan closes that gap permanently using the sentinel pattern already established for `commands.md` and `callbacks.md`.

Output: Generator test file, generator code fix, 21 module pages with sentinel comments, clean round-trip on `make generate-docs`.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-tech-debt-sentinel-guard-and-metadata-backfill/07-RESEARCH.md

Source files:
@scripts/generate_docs/generators.go
@scripts/generate_docs/parsers_test.go
</context>

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From scripts/generate_docs/generators.go (lines 13-26):
```go
const manualMaintenanceSentinel = "<!-- MANUALLY MAINTAINED: do not regenerate -->"

func skipIfManuallyMaintained(filePath string) bool {
    data, err := os.ReadFile(filePath)
    if err != nil {
        return false // File doesn't exist, proceed with generation
    }
    checkLen := min(512, len(data))
    return strings.Contains(string(data[:checkLen]), manualMaintenanceSentinel)
}
```

From scripts/generate_docs/generators.go (lines 28-32 — the function to modify):
```go
func generateModuleDocs(modules []Module, outputPath string) error {
    for _, module := range modules {
        moduleDir := filepath.Join(outputPath, "commands", module.Name)
        moduleFile := filepath.Join(moduleDir, "index.md")

        log.Debugf("Generating module doc: %s", module.DisplayName)
        // ... continues with content generation and file write
```

Module struct (from parsers.go):
```go
type Module struct {
    Name         string
    DisplayName  string
    HelpText     string
    ExtendedDocs struct {
        Extended string
    }
    Aliases  []string
    Commands []Command
    Features []string
}
```

Existing sentinel guard pattern (from generateCommandReference, line ~169):
```go
func generateCommandReference(modules []Module, outputPath string) error {
    refDir := filepath.Join(outputPath, "api-reference")
    refFile := filepath.Join(refDir, "commands.md")

    if skipIfManuallyMaintained(refFile) {
        log.Infof("Skipped: %s (manually maintained)", filepath.Base(refFile))
        return nil   // <-- uses return nil because this handles ONE file
    }
```
</interfaces>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: RED — Write failing tests for sentinel guard in generateModuleDocs</name>
  <files>scripts/generate_docs/generators_test.go</files>
  <behavior>
    - Test 1 (TestGenerateModuleDocs_SkipsManuallyMaintainedFiles): Create a tmpDir with `commands/testmodule/index.md` containing the sentinel comment and hand-crafted content. Call `generateModuleDocs()` with a Module named "testmodule". Assert the file content is UNCHANGED after the call (sentinel-protected file NOT overwritten).
    - Test 2 (TestGenerateModuleDocs_WritesNonSentinelFiles): Call `generateModuleDocs()` with a Module named "newmodule" and no pre-existing file. Assert the file IS created at `commands/newmodule/index.md`.
    - Test 3 (TestGenerateModuleDocs_MixedSentinelAndNonSentinel): Create TWO modules — one with sentinel (protected), one without. Call `generateModuleDocs()`. Assert: protected file unchanged, non-protected file created. This verifies `continue` is used (not `return nil`) — the function does not exit after skipping the first protected file.
  </behavior>
  <action>
Create `scripts/generate_docs/generators_test.go` in `package main` (same package as generators.go — needed for accessing `manualMaintenanceSentinel` const and `generateModuleDocs` function).

Test 1 setup:
```go
func TestGenerateModuleDocs_SkipsManuallyMaintainedFiles(t *testing.T) {
    tmpDir := t.TempDir()
    moduleDir := filepath.Join(tmpDir, "commands", "testmodule")
    if err := os.MkdirAll(moduleDir, 0755); err != nil {
        t.Fatalf("Failed to create module dir: %v", err)
    }
    originalContent := "---\ntitle: Test\n---\n" + manualMaintenanceSentinel + "\n\n# Hand-crafted content"
    moduleFile := filepath.Join(moduleDir, "index.md")
    if err := os.WriteFile(moduleFile, []byte(originalContent), 0644); err != nil {
        t.Fatalf("Failed to write sentinel file: %v", err)
    }
    modules := []Module{{Name: "testmodule", DisplayName: "Test", HelpText: "some help"}}
    if err := generateModuleDocs(modules, tmpDir); err != nil {
        t.Fatalf("generateModuleDocs returned error: %v", err)
    }
    got, err := os.ReadFile(moduleFile)
    if err != nil {
        t.Fatalf("Failed to read file: %v", err)
    }
    if string(got) != originalContent {
        t.Errorf("Sentinel-protected file was overwritten.\nExpected: %q\nGot: %q", originalContent, string(got))
    }
}
```

Test 2 setup:
```go
func TestGenerateModuleDocs_WritesNonSentinelFiles(t *testing.T) {
    tmpDir := t.TempDir()
    modules := []Module{{Name: "newmodule", DisplayName: "New Module", HelpText: "help text"}}
    if err := generateModuleDocs(modules, tmpDir); err != nil {
        t.Fatalf("generateModuleDocs returned error: %v", err)
    }
    moduleFile := filepath.Join(tmpDir, "commands", "newmodule", "index.md")
    if _, err := os.Stat(moduleFile); os.IsNotExist(err) {
        t.Error("Expected module file to be created but it was not")
    }
}
```

Test 3 setup:
```go
func TestGenerateModuleDocs_MixedSentinelAndNonSentinel(t *testing.T) {
    tmpDir := t.TempDir()
    // Protected module
    protectedDir := filepath.Join(tmpDir, "commands", "protected")
    if err := os.MkdirAll(protectedDir, 0755); err != nil {
        t.Fatalf("Failed to create protected dir: %v", err)
    }
    protectedContent := "---\ntitle: Protected\n---\n" + manualMaintenanceSentinel + "\n\n# Do not overwrite"
    protectedFile := filepath.Join(protectedDir, "index.md")
    if err := os.WriteFile(protectedFile, []byte(protectedContent), 0644); err != nil {
        t.Fatalf("Failed to write protected file: %v", err)
    }
    // Two modules: one protected, one not
    modules := []Module{
        {Name: "protected", DisplayName: "Protected", HelpText: "protected help"},
        {Name: "unprotected", DisplayName: "Unprotected", HelpText: "unprotected help"},
    }
    if err := generateModuleDocs(modules, tmpDir); err != nil {
        t.Fatalf("generateModuleDocs returned error: %v", err)
    }
    // Protected file must be unchanged
    got, err := os.ReadFile(protectedFile)
    if err != nil {
        t.Fatalf("Failed to read protected file: %v", err)
    }
    if string(got) != protectedContent {
        t.Errorf("Protected file was overwritten")
    }
    // Unprotected file must be created
    unprotectedFile := filepath.Join(tmpDir, "commands", "unprotected", "index.md")
    if _, err := os.Stat(unprotectedFile); os.IsNotExist(err) {
        t.Error("Unprotected file was NOT created — likely used return nil instead of continue")
    }
}
```

Run tests — they MUST FAIL (RED phase). Tests 1 and 3's protected-file assertion will fail because `generateModuleDocs()` does not yet call `skipIfManuallyMaintained()`.

**CRITICAL:** Confirm the tests fail with the expected error message (sentinel-protected file WAS overwritten) before proceeding. If tests pass, the sentinel guard already exists and something is wrong with test setup.
  </action>
  <verify>
    <automated>cd scripts/generate_docs && go test -run "TestGenerateModuleDocs" -v ./... 2>&1 | grep -E "FAIL|PASS"</automated>
  </verify>
  <done>Three tests exist in generators_test.go. Tests 1 and 3 FAIL (sentinel-protected files are overwritten). Test 2 PASSES (non-sentinel file is created). This confirms RED phase.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: GREEN — Add sentinel guard to generateModuleDocs + restore module pages + insert sentinels</name>
  <files>
    scripts/generate_docs/generators.go,
    docs/src/content/docs/commands/admin/index.md,
    docs/src/content/docs/commands/antiflood/index.md,
    docs/src/content/docs/commands/antispam/index.md,
    docs/src/content/docs/commands/bans/index.md,
    docs/src/content/docs/commands/blacklists/index.md,
    docs/src/content/docs/commands/captcha/index.md,
    docs/src/content/docs/commands/connections/index.md,
    docs/src/content/docs/commands/disabling/index.md,
    docs/src/content/docs/commands/filters/index.md,
    docs/src/content/docs/commands/formatting/index.md,
    docs/src/content/docs/commands/greetings/index.md,
    docs/src/content/docs/commands/languages/index.md,
    docs/src/content/docs/commands/locks/index.md,
    docs/src/content/docs/commands/misc/index.md,
    docs/src/content/docs/commands/mutes/index.md,
    docs/src/content/docs/commands/notes/index.md,
    docs/src/content/docs/commands/pins/index.md,
    docs/src/content/docs/commands/purges/index.md,
    docs/src/content/docs/commands/reports/index.md,
    docs/src/content/docs/commands/rules/index.md,
    docs/src/content/docs/commands/warns/index.md
  </files>
  <action>
**Step 1: Add sentinel guard to generators.go**

In `scripts/generate_docs/generators.go`, inside the `generateModuleDocs()` function, add the sentinel check immediately after the `moduleFile` variable is defined (after line 32) and BEFORE the `log.Debugf` call. Use `continue` (NOT `return nil`) because this is inside a `for` loop.

Add these 3 lines after `moduleFile := filepath.Join(moduleDir, "index.md")`:
```go
        if skipIfManuallyMaintained(moduleFile) {
            log.Infof("Skipped: commands/%s/index.md (manually maintained)", module.Name)
            continue
        }
```

**Step 2: Run tests — confirm GREEN**

Run `cd scripts/generate_docs && go test -run "TestGenerateModuleDocs" -v ./...`

All 3 tests must now PASS. If any fail, debug the placement of the sentinel check.

**Step 3: Restore dirty module pages from git HEAD**

The 21 module pages in the working tree are currently auto-generated overwrites (dirty). Restore the committed hand-crafted versions:

```bash
git restore docs/src/content/docs/commands/admin/index.md \
  docs/src/content/docs/commands/antiflood/index.md \
  docs/src/content/docs/commands/antispam/index.md \
  docs/src/content/docs/commands/bans/index.md \
  docs/src/content/docs/commands/blacklists/index.md \
  docs/src/content/docs/commands/captcha/index.md \
  docs/src/content/docs/commands/connections/index.md \
  docs/src/content/docs/commands/disabling/index.md \
  docs/src/content/docs/commands/filters/index.md \
  docs/src/content/docs/commands/formatting/index.md \
  docs/src/content/docs/commands/greetings/index.md \
  docs/src/content/docs/commands/languages/index.md \
  docs/src/content/docs/commands/locks/index.md \
  docs/src/content/docs/commands/misc/index.md \
  docs/src/content/docs/commands/mutes/index.md \
  docs/src/content/docs/commands/notes/index.md \
  docs/src/content/docs/commands/pins/index.md \
  docs/src/content/docs/commands/purges/index.md \
  docs/src/content/docs/commands/reports/index.md \
  docs/src/content/docs/commands/rules/index.md \
  docs/src/content/docs/commands/warns/index.md
```

Verify: `git status --short docs/src/content/docs/commands/*/index.md` should show NO output (all clean).

**Step 4: Insert sentinel comment into all 21 module pages**

For EACH of the 21 module pages, insert the sentinel comment `<!-- MANUALLY MAINTAINED: do not regenerate -->` on a new line immediately after the closing `---` of the YAML frontmatter block. The sentinel must appear BEFORE any content.

The exact string is: `<!-- MANUALLY MAINTAINED: do not regenerate -->`

Place it right after the closing `---` of frontmatter, on its own line. Example result:
```markdown
---
title: Admin Commands
description: Complete guide to Admin module commands and features
---
<!-- MANUALLY MAINTAINED: do not regenerate -->

# ...
```

Use `sed` for all 21 files. The pattern: find the SECOND `---` line (closing frontmatter) and append the sentinel line after it.

```bash
for f in docs/src/content/docs/commands/*/index.md; do
  # Skip devs, help, users — they are not generated by generateModuleDocs
  dir=$(basename $(dirname "$f"))
  case "$dir" in devs|help|users) continue ;; esac
  # Insert sentinel after closing frontmatter (second --- line)
  sed -i '' '/^---$/{ x; s/^$/found/; x; /^---$/a\
<!-- MANUALLY MAINTAINED: do not regenerate -->
}' "$f"
done
```

**IMPORTANT:** If `sed` is unreliable for this, use the Edit tool on each file individually. The sentinel line goes immediately after the second `---` on a new line by itself.

**Step 5: Verify sentinel placement**

```bash
# All 21 generator-produced module pages must have the sentinel
grep -rL "MANUALLY MAINTAINED: do not regenerate" docs/src/content/docs/commands/*/index.md | grep -v -E "(devs|help|users)"
# Expected: NO output (all 21 have it)

# devs, help, users should NOT have sentinel (they are not generated)
grep -rL "MANUALLY MAINTAINED: do not regenerate" docs/src/content/docs/commands/devs/index.md docs/src/content/docs/commands/help/index.md docs/src/content/docs/commands/users/index.md
# Expected: all 3 files listed (they lack sentinel — correct)
```

**Step 6: Round-trip verification**

```bash
make generate-docs
git status --short docs/src/content/docs/commands/*/index.md
# Expected: NO output — no module pages modified
```

If any module page shows as modified, `make generate-docs` is still overwriting it. Debug by checking if the sentinel is in the first 512 bytes of that file.

**CRITICAL ANTI-PATTERNS:**
- Do NOT use `return nil` in the generator fix — use `continue`. This is a `for` loop.
- Do NOT add sentinel to devs, help, or users pages — those are not generated by `generateModuleDocs()`.
- Do NOT skip the `git restore` step — adding sentinel to the dirty auto-generated versions protects the wrong content.
- The sentinel text must be EXACTLY `<!-- MANUALLY MAINTAINED: do not regenerate -->` — no capitalization or punctuation changes.
  </action>
  <verify>
    <automated>cd scripts/generate_docs && go test -run "TestGenerateModuleDocs" -v ./... && cd ../.. && make generate-docs && git status --short "docs/src/content/docs/commands/*/index.md" | grep "^.M" && echo "FAIL: module pages modified" || echo "PASS: no module pages modified"</automated>
  </verify>
  <done>All 3 unit tests pass (GREEN). All 21 module pages have sentinel comment after frontmatter. `make generate-docs` produces no changes to any module page. `git status` shows no dirty module pages. devs/help/users pages do NOT have sentinel (correct — they are not generated).</done>
</task>

</tasks>

<verification>
1. `cd scripts/generate_docs && go test -v -race ./...` — all tests pass including new sentinel guard tests
2. `grep -c "MANUALLY MAINTAINED: do not regenerate" docs/src/content/docs/commands/*/index.md | grep -v -E "(devs|help|users)" | grep ":0$"` — expect NO output (all 21 have sentinel)
3. `make generate-docs && git status --short docs/src/content/docs/commands/*/index.md` — expect NO output (clean round-trip)
4. `grep -c "skipIfManuallyMaintained(moduleFile)" scripts/generate_docs/generators.go` — returns 1
</verification>

<success_criteria>
- generators_test.go exists with 3 passing tests covering sentinel skip, non-sentinel write, and mixed behavior
- generators.go has `skipIfManuallyMaintained(moduleFile)` call inside generateModuleDocs for-loop using `continue`
- All 21 module pages (admin through warns, excluding devs/help/users) contain sentinel comment
- `make generate-docs` produces zero changes to any sentinel-protected file
- Working tree clean for all module pages after generate-docs
</success_criteria>

<output>
After completion, create `.planning/phases/07-tech-debt-sentinel-guard-and-metadata-backfill/07-01-SUMMARY.md`
</output>
