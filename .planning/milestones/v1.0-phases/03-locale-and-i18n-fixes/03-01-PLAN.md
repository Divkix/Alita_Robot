---
phase: 03-locale-and-i18n-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/check_translations/main.go
  - scripts/check_translations/main_test.go
  - locales/en.yml
autonomous: true
requirements: [I18N-01, I18N-03, I18N-06]

must_haves:
  truths:
    - "check-translations does not report test fixture keys (nonexistent_key_xyz, fallback_key, greet, greeting, some_key, static, templ, empty string) as missing"
    - "EN locale contains all 10 production keys that Go code references via tr.GetString()"
    - "Old key names (devs_getting_chatlist, devs_chatlist_caption, devs_no_team_members, devs_no_users_in_category) and old greetings button keys (_button suffix) are removed from EN"
  artifacts:
    - path: "scripts/check_translations/main.go"
      provides: "_test.go file exclusion in extractTranslationKeys walk"
      contains: "strings.HasSuffix(path, \"_test.go\")"
    - path: "scripts/check_translations/main_test.go"
      provides: "Unit test proving _test.go files are excluded"
      contains: "TestExtractKeys"
    - path: "locales/en.yml"
      provides: "All 10 missing production keys + 7 old keys removed"
  key_links:
    - from: "scripts/check_translations/main.go"
      to: "locales/en.yml"
      via: "key extraction vs locale YAML comparison"
      pattern: "strings.HasSuffix.*_test.go"
---

<objective>
Fix the check-translations script to exclude `_test.go` files from key extraction (eliminating 8 false positives), then add all 10 missing production keys to the EN locale and remove 7 obsolete old-named keys.

Purpose: EN is the canonical locale — all other locales fall back to it. Missing EN keys cause silent empty strings in the bot. Old keys cause confusion and clutter. The script bug masks real gaps behind false positives.

Output: A clean EN locale with all production keys present, old keys removed, and a script that only reports genuine missing translations.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-locale-and-i18n-fixes/03-RESEARCH.md

Key reference — the 10 missing production keys (from RESEARCH.md):

| Code Key | Source File | EN Old Key (if rename) | Notes |
|----------|------------|----------------------|-------|
| `bans_cannot_identify_user` | bans.go:72 | — | New key, never existed |
| `captcha_internal_error` | captcha.go:713 | — | New key, never existed |
| `devs_chat_list_caption` | devs.go:143 | `devs_chatlist_caption` | Rename: add underscore |
| `devs_getting_chat_list` | devs.go:92 | `devs_getting_chatlist` | Rename: add underscore |
| `devs_no_team_users` | devs.go:450 | `devs_no_team_members` | Rename: members→users |
| `devs_no_users` | devs.go:467 | `devs_no_users_in_category` | Rename: shortened |
| `greetings_join_request_approve_btn` | greetings.go:985 | `greetings_join_request_approve_button` | Rename: button→btn |
| `greetings_join_request_ban_btn` | greetings.go:987 | `greetings_join_request_ban_button` | Rename: button→btn |
| `greetings_join_request_decline_btn` | greetings.go:986 | `greetings_join_request_decline_button` | Rename: button→btn |
| `reports_cannot_report_channel` | reports.go:56,316,336 | — | New key, never existed |

Old keys to remove from EN (7 total — confirmed no production code references):
- `devs_getting_chatlist` (line 1239)
- `devs_chatlist_caption` (line 1240)
- `devs_no_team_members` (line 1250)
- `devs_no_users_in_category` (line 1253)
- `greetings_join_request_approve_button` (line 1302)
- `greetings_join_request_decline_button` (line 1303)
- `greetings_join_request_ban_button` (line 1304)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix check-translations to exclude _test.go files and add unit test</name>
  <files>scripts/check_translations/main.go, scripts/check_translations/main_test.go</files>
  <action>
In `scripts/check_translations/main.go`, function `extractTranslationKeys`, at line 96 change the walk callback's skip condition from:

```go
if d.IsDir() || !strings.HasSuffix(path, ".go") {
    return nil
}
```

to:

```go
if d.IsDir() || !strings.HasSuffix(path, ".go") || strings.HasSuffix(path, "_test.go") {
    return nil
}
```

Then in `scripts/check_translations/main_test.go`, add a new test function `TestExtractTranslationKeys_ExcludesTestFiles` that:
1. Creates a temp directory with two files:
   - `module.go` containing `tr.GetString("real_key")` — should be extracted
   - `module_test.go` containing `tr.GetString("test_only_key")` — should be excluded
2. Calls `extractTranslationKeys(tmpDir)`
3. Asserts that `real_key` IS in the returned keys
4. Asserts that `test_only_key` is NOT in the returned keys

Run the test to confirm it passes. This eliminates the 8 false-positive test fixture keys from check-translations output.
  </action>
  <verify>
    <automated>cd scripts/check_translations && go test -run TestExtractTranslationKeys_ExcludesTestFiles -v</automated>
  </verify>
  <done>
    - `_test.go` files are skipped during translation key extraction
    - Unit test proves the exclusion works
    - `make check-translations` no longer reports test fixture keys (nonexistent_key_xyz, fallback_key, greet, greeting, some_key, static, templ, empty string)
  </done>
</task>

<task type="auto">
  <name>Task 2: Add 10 missing production keys to EN locale and remove 7 obsolete old keys</name>
  <files>locales/en.yml</files>
  <action>
Edit `locales/en.yml` to add the 10 missing production keys. Place each new key near its contextual neighbors (same module section). Use the exact values below — these are derived from the code context and match existing EN tone/style:

**New keys to ADD (copy the EN value from the old key name where it's a rename; use new text for genuinely new keys):**

For renames — copy the value from the old key:
- `devs_getting_chat_list: Getting list of chats I'm in...` (copy from `devs_getting_chatlist`)
- `devs_chat_list_caption: Here is the list of chats in my Database!` (copy from `devs_chatlist_caption`)
- `devs_no_team_users: No users are added in Team!` (corrected from `devs_no_team_members` which has a duplicated "added" typo)
- `devs_no_users: "No Users"` (copy from `devs_no_users_in_category`)
- `greetings_join_request_approve_btn: "✅ Approve"` (copy from `greetings_join_request_approve_button`)
- `greetings_join_request_decline_btn: "❌ Decline"` (copy from `greetings_join_request_decline_button`)
- `greetings_join_request_ban_btn: "✅ Ban"` (copy from `greetings_join_request_ban_button`)

For genuinely new keys (no old equivalent):
- `bans_cannot_identify_user: "Cannot identify the user from the replied message."` (place near other bans_ keys)
- `captcha_internal_error: "An internal error occurred while updating captcha settings. Please try again."` (place near other captcha_ keys)
- `reports_cannot_report_channel: "You can't report a channel post."` (place near other reports_ keys)

**Old keys to REMOVE (7 total — no production code references, confirmed by grep):**
- Delete line with `devs_getting_chatlist:` (line ~1239)
- Delete line with `devs_chatlist_caption:` (line ~1240)
- Delete line with `devs_no_team_members:` (line ~1250)
- Delete line with `devs_no_users_in_category:` (line ~1253)
- Delete line with `greetings_join_request_approve_button:` (line ~1302)
- Delete line with `greetings_join_request_decline_button:` (line ~1303)
- Delete line with `greetings_join_request_ban_button:` (line ~1304)

After editing, validate YAML parses cleanly:
```bash
python3 -c "import yaml; d=yaml.safe_load(open('locales/en.yml')); print(f'{len(d)} keys')"
```

The count should be 838 (835 original + 10 added - 7 removed = 838).
  </action>
  <verify>
    <automated>python3 -c "import yaml; d=yaml.safe_load(open('locales/en.yml')); assert len(d) == 838, f'Expected 838 keys, got {len(d)}'; missing = [k for k in ['bans_cannot_identify_user','captcha_internal_error','devs_chat_list_caption','devs_getting_chat_list','devs_no_team_users','devs_no_users','greetings_join_request_approve_btn','greetings_join_request_ban_btn','greetings_join_request_decline_btn','reports_cannot_report_channel'] if k not in d]; assert not missing, f'Missing: {missing}'; old = [k for k in ['devs_getting_chatlist','devs_chatlist_caption','devs_no_team_members','devs_no_users_in_category','greetings_join_request_approve_button','greetings_join_request_decline_button','greetings_join_request_ban_button'] if k in d]; assert not old, f'Old keys still present: {old}'; v = d.get('devs_no_team_users',''); assert 'added Added' not in v, f'devs_no_team_users has duplicated word typo: {v!r}'; assert v == 'No users are added in Team!', f'devs_no_team_users unexpected value: {v!r}'; print('EN locale: all 10 new keys present, all 7 old keys removed, values verified')"</automated>
  </verify>
  <done>
    - EN locale contains all 10 production keys matching code-referenced names
    - EN locale no longer contains 7 obsolete old-named keys
    - YAML file parses cleanly with 838 keys total
  </done>
</task>

</tasks>

<verification>
1. `cd scripts/check_translations && go test ./... -v` — all tests pass including new _test.go exclusion test
2. `python3 -c "import yaml; d=yaml.safe_load(open('locales/en.yml')); print(len(d))"` — outputs 838
3. `make check-translations` — EN locale reports 0 missing keys (other locales still have gaps until plan 03-02)
</verification>

<success_criteria>
- check-translations script excludes _test.go files (8 false positives eliminated)
- EN locale has all 10 production keys present with correct key names
- 7 obsolete old key names removed from EN locale
- YAML file parses cleanly
- Unit test exists proving _test.go exclusion
</success_criteria>

<output>
After completion, create `.planning/phases/03-locale-and-i18n-fixes/03-01-SUMMARY.md`
</output>
