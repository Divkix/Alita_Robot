---
phase: 02-api-reference-and-command-documentation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - docs/src/content/docs/api-reference/commands.md
  - docs/src/content/docs/api-reference/callbacks.md
autonomous: true
requirements:
  - DOCS-02
  - DOCS-03
  - DOCS-04
  - DOCS-05
  - DOCS-07

must_haves:
  truths:
    - "`api-reference/commands.md` contains all 142 commands from the canonical inventory including the 13 previously missing commands (start, help, donate, about, stats, addsudo, adddev, remsudo, remdev, chatinfo, chatlist, leavechat, teamusers)"
    - "The commands table uses the new column structure: Command | Description | Permission | Disableable | Aliases"
    - "All 8 MultiCommand aliases have their own rows with 'Alias of /primary' notation in both the module tables and alphabetical index"
    - "Exactly 17 commands are marked as disableable (matching the canonical inventory count)"
    - "Permission column values match actual handler guards: Everyone, Admin, Owner, Dev/Owner, Team, User/Admin"
    - "`callbacks.md` documents the versioned codec format (`namespace|v1|url-encoded-fields`) with encode/decode Go code example"
    - "The old dot-notation explanation in callbacks.md is replaced with the versioned format, plus a backward-compatibility note"
  artifacts:
    - path: "docs/src/content/docs/api-reference/commands.md"
      provides: "Complete command reference with 142 commands, new column format, aliases, permissions"
      contains: "Alias of"
    - path: "docs/src/content/docs/api-reference/callbacks.md"
      provides: "Updated callback reference with versioned codec format"
      contains: "namespace|v1|url-encoded-fields"
  key_links:
    - from: "docs/src/content/docs/api-reference/commands.md"
      to: ".planning/INVENTORY.json"
      via: "All command data sourced from canonical inventory"
      pattern: "142"
    - from: "docs/src/content/docs/api-reference/callbacks.md"
      to: "alita/utils/callbackcodec/callbackcodec.go"
      via: "Codec format specification matches actual implementation"
      pattern: "namespace|v1"
---

<objective>
Rewrite the API reference command table with the new column format and add all 13 missing commands. Update callbacks.md with the versioned codec format.

Purpose: The current `commands.md` is missing 13 commands (entire devs and help modules), uses a "Handler" column instead of "Description", has no "Permission" column, and claims 21 modules / 129 commands (should be 25 modules / 142 commands). The `callbacks.md` documents the old dot-notation format that has been replaced by the versioned codec.

Output: Rewritten `commands.md` with 142 commands in the new table format and updated `callbacks.md` with versioned codec documentation.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-api-reference-and-command-documentation/02-RESEARCH.md
@.planning/INVENTORY.json

<interfaces>
<!-- New table format per CONTEXT.md locked decision -->
<!-- api-reference/commands.md ONLY ‚Äî module pages keep their existing 3-column format -->

New column structure:
| Command | Description | Permission | Disableable | Aliases |
|---------|-------------|------------|-------------|---------|
| `/start` | Show welcome message with navigation menu | Everyone | ‚ùå | ‚Äî |

Permission level values:
- "Everyone" ‚Äî no permission guard in handler
- "Admin" ‚Äî RequireUserAdmin() or RequireUserOwner() guard
- "Owner" ‚Äî user.Id != config.AppConfig.OwnerId guard (bot owner)
- "Dev/Owner" ‚Äî user.Id != config.AppConfig.OwnerId && !memStatus.Dev guard
- "Team" ‚Äî FindInInt64Slice(teamint64Slice, user.Id) guard
- "User/Admin" ‚Äî asymmetric: any user in private, admin in groups (language module only)

Alias notation for MultiCommand pairs:
| `/rmallbl` | Alias of `/remallbl` | Admin | ‚ùå | ‚Äî |

<!-- Callback codec format from alita/utils/callbackcodec/callbackcodec.go -->

Encode: namespace|v1|url-query-encoded-fields
Empty payload: namespace|v1|_
Max length: 64 bytes (Telegram limit)

Example encode/decode:
```go
data, err := callbackcodec.Encode("helpq", map[string]string{"m": "Help"})
// ‚Üí "helpq|v1|m=Help"

decoded, err := callbackcodec.Decode("helpq|v1|m=Help")
module, _ := decoded.Field("m") // "Help"
```

<!-- Complete list of 13 missing commands to add -->

Help module (4 commands, all "Everyone" permission):
- start ‚Üí Show welcome message with navigation menu
- help ‚Üí Show help menu with module list
- donate ‚Üí Show donation information
- about ‚Üí Show bot information and links

Devs module (9 commands, mixed permissions):
- stats ‚Üí Display bot statistics and system info (Dev/Owner)
- addsudo ‚Üí Grant sudo permissions to a user (Owner)
- adddev ‚Üí Grant developer permissions to a user (Owner)
- remsudo ‚Üí Revoke sudo permissions from a user (Owner)
- remdev ‚Üí Revoke developer permissions from a user (Owner)
- teamusers ‚Üí List all team members (Team)
- chatinfo ‚Üí Display detailed information about a chat (Dev/Owner)
- chatlist ‚Üí Generate and send a list of all active chats (Dev/Owner)
- leavechat ‚Üí Force the bot to leave a specified chat (Dev/Owner)

<!-- Disableable commands (17 total per inventory) -->

admin/adminlist, antiflood/flood, blacklists/blacklists, disabling/disabled,
filters/filters, locks/locks, locks/locktypes, misc/id, misc/info, misc/ping,
misc/stat, misc/tr, notes/get, notes/notes, reports/report, rules/rules, warns/warns

<!-- MultiCommand alias pairs (8 commands = 4 pairs) -->

blacklists: remallbl ‚Üî rmallbl
formatting: formatting ‚Üî markdownhelp
notes: privnote ‚Üî privatenotes
rules: resetrules ‚Üî clearrules

For each pair, one is the "primary" (the first listed in the MultiCommand call).
In the command table, both get their own rows. The alias row gets:
Description = "Alias of /primary"
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite api-reference/commands.md with new format and all 142 commands</name>
  <files>docs/src/content/docs/api-reference/commands.md</files>
  <action>
Rewrite the entire `docs/src/content/docs/api-reference/commands.md` file. This is a full rewrite, not incremental edits ‚Äî the column structure changes and 13 commands are added.

**Header section:**

Keep the frontmatter. Update the Overview counts:
```markdown
## Overview

- **Total Modules**: 25 (24 user-facing + 1 internal)
- **Total Commands**: 142
```

**Commands by Module sections:**

Rewrite every module table with the new 5-column format:
```markdown
| Command | Description | Permission | Disableable | Aliases |
```

For EACH module section:
1. Keep the existing emoji + module name heading (e.g., `### üëë Admin`)
2. Replace the 4-column table (Command|Handler|Disableable|Aliases) with 5-column table (Command|Description|Permission|Disableable|Aliases)
3. Fill in ALL "No description available" entries with terse functional descriptions
4. Add the Permission column based on handler guard analysis
5. Verify Disableable column against the 17 disableable commands listed in interfaces

**New module sections to ADD (currently missing entirely):**

Add `### üîß Devs` section with all 9 commands:

| Command | Description | Permission | Disableable | Aliases |
|---------|-------------|------------|-------------|---------|
| `/addsudo` | Grant sudo permissions to a user | Owner | ‚ùå | ‚Äî |
| `/adddev` | Grant developer permissions to a user | Owner | ‚ùå | ‚Äî |
| `/chatinfo` | Display detailed information about a chat | Dev/Owner | ‚ùå | ‚Äî |
| `/chatlist` | Generate and send a list of all active chats | Dev/Owner | ‚ùå | ‚Äî |
| `/leavechat` | Force the bot to leave a specified chat | Dev/Owner | ‚ùå | ‚Äî |
| `/remdev` | Revoke developer permissions from a user | Owner | ‚ùå | ‚Äî |
| `/remsudo` | Revoke sudo permissions from a user | Owner | ‚ùå | ‚Äî |
| `/stats` | Display bot statistics and system info | Dev/Owner | ‚ùå | ‚Äî |
| `/teamusers` | List all team members | Team | ‚ùå | ‚Äî |

Add `### ‚ùì Help` section with all 4 commands:

| Command | Description | Permission | Disableable | Aliases |
|---------|-------------|------------|-------------|---------|
| `/about` | Show bot information and links | Everyone | ‚ùå | ‚Äî |
| `/donate` | Show donation information | Everyone | ‚ùå | ‚Äî |
| `/help` | Show help menu with module list | Everyone | ‚ùå | ‚Äî |
| `/start` | Show welcome message with navigation menu | Everyone | ‚ùå | ‚Äî |

**Alias rows in module tables:**

For each MultiCommand pair, BOTH commands get their own row. The alias gets "Alias of /primary" as its description. Determine which is primary by using the first one listed. Here are the pairs and how to document them:

- Blacklists: `/remallbl` is primary ‚Üí `/rmallbl` gets "Alias of `/remallbl`"
- Formatting: `/markdownhelp` is primary ‚Üí `/formatting` gets "Alias of `/markdownhelp`"
- Notes: `/privnote` is primary ‚Üí `/privatenotes` gets "Alias of `/privnote`"
- Rules: `/resetrules` is primary ‚Üí `/clearrules` gets "Alias of `/resetrules`"

Both the primary and alias rows must have the same Permission and Disableable values.

**Existing module description normalization:**

While rewriting each module's table, normalize ALL existing descriptions to the terse functional tone. Examples of normalization:
- "bans a user. (via handle, or reply)" ‚Üí "Ban a user"
- "kicks the user who issued the command." ‚Üí "Kick yourself from the group"
- "Gets the count of the total number of messages in the chat." ‚Üí "Show message count for the chat"
- "List the admins in the current chat." ‚Üí "List chat admins"

Keep descriptions under ~60 characters where possible. Action-oriented verb form: "Ban a user" not "Bans a user" or "This command bans a user".

**Permission column values for existing modules:**

Use these permission assignments (verified from source code):
- Admin module: all Admin except `/adminlist` (Everyone) and `/anonadmin` (Admin)
- Antiflood: all Admin
- Bans: all Admin except `/kickme` (Everyone)
- Blacklists: all Admin
- Captcha: all Admin
- Connections: `/connect` (Everyone), `/disconnect` (Everyone), `/reconnect` (Everyone), `/connection` (Everyone), `/allowconnect` (Admin)
- Disabling: all Admin
- Filters: all Admin except `/filters` (Everyone ‚Äî lists filters)
- Formatting: all Everyone
- Greetings: all Admin
- Languages: User/Admin (per asymmetric permission pattern)
- Locks: all Admin
- Misc: all Everyone
- Mutes: all Admin
- Notes: `/save`/`/addnote` (Admin), `/clear`/`/rmnote`/`/clearall` (Admin), `/get`/`/notes`/`/saved` (Everyone), `/privnote`/`/privatenotes` (Admin)
- Pins: all Admin
- Purges: all Admin
- Reports: `/report` (Everyone), `/reports` (Admin)
- Rules: `/rules` (Everyone), all others (Admin)
- Warns: all Admin except `/warns` (Everyone ‚Äî view own warns) and `/warnings` (Everyone)

**Alphabetical Index update:**

Rewrite the Alphabetical Index section with the new column format:
```markdown
| Command | Module | Description | Permission |
```

Replace "Handler" with "Description" and add "Permission". Add all 13 missing commands in alphabetical order. Include alias rows.

**Section ordering for module tables:**

Place the modules in this order (matching the index.mdx categories):
1. Administration: Admin
2. Moderation: Antiflood, Antispam (note: 0 commands), Bans, Blacklists, Captcha, Locks, Mutes, Purges, Warns
3. Content Management: Filters, Formatting, Greetings, Notes, Rules
4. User Tools: Misc, Reports
5. Bot Management: Connections, Disabling, Help, Languages, Pins
6. Developer: Devs
7. Internal: Users (note: 0 commands ‚Äî add a brief note "No commands ‚Äî passive background tracker")

Note: Antispam and Users have 0 commands. For these, do NOT include an empty table. Instead add a note: "This module has no user-facing commands. See [module page](/commands/antispam/) for details." with the correct module path.
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot && TABLE_ROWS=$(grep -c '^|' docs/src/content/docs/api-reference/commands.md) && [ "$TABLE_ROWS" -gt 140 ] && grep -q "/start" docs/src/content/docs/api-reference/commands.md && ALIAS_COUNT=$(grep -c "Alias of" docs/src/content/docs/api-reference/commands.md) && [ "$ALIAS_COUNT" -ge 4 ] && grep -q "Dev/Owner" docs/src/content/docs/api-reference/commands.md && echo "PASS"</automated>
  </verify>
  <done>commands.md contains all 142 commands in the new 5-column format (Command|Description|Permission|Disableable|Aliases). All 13 previously missing commands are present. All 8 alias rows use "Alias of /primary" notation. Permission column matches handler guards. Exactly 17 commands marked disableable. All descriptions use terse functional tone. Total count shows 25 modules / 142 commands.</done>
</task>

<task type="auto">
  <name>Task 2: Update callbacks.md with versioned codec format</name>
  <files>docs/src/content/docs/api-reference/callbacks.md</files>
  <action>
Update `docs/src/content/docs/api-reference/callbacks.md` to replace the old dot-notation format with the versioned codec format. Read the current file first.

**Replace the "Callback Data Format" section** (currently says "Callbacks use a prefix-based routing system" with `{prefix}{data}` example):

Replace with:
```markdown
## Callback Data Format

Callbacks use a versioned codec with URL-encoded fields:

```
<namespace>|v1|<url-encoded-fields>
```

For example: `restrict|v1|a=ban&uid=123456789` routes to the `restrict` namespace handler.

When the payload has no fields, `_` is used as placeholder: `helpq|v1|m=Help`.

**Maximum length**: 64 bytes (Telegram's `callback_data` limit).

### Backward Compatibility

Legacy dot-notation (`prefix.field1.field2`) is accepted by handlers for backward compatibility but is deprecated. All new callbacks use the versioned format.
```

**Replace the "Registering Callbacks" code example** at the bottom of the file. The current example uses `callbackquery.Prefix("myprefix.")` which shows the old dot-notation. Replace the entire "Registering Callbacks" and "Handling Callbacks" sections with a single "Code Example" section:

```markdown
## Code Example

### Encoding and Decoding Callback Data

```go
// Encode callback data
data, err := callbackcodec.Encode("restrict", map[string]string{
    "a":   "ban",
    "uid": "123456789",
})
// ‚Üí "restrict|v1|a=ban&uid=123456789"

// Empty payload
data, err := callbackcodec.Encode("helpq", map[string]string{})
// ‚Üí "helpq|v1|_"

// Decode callback data
decoded, err := callbackcodec.Decode("restrict|v1|a=ban&uid=123456789")
namespace := decoded.Namespace  // "restrict"
action, _ := decoded.Field("a") // "ban"
uid, _ := decoded.Field("uid")  // "123456789"
```

### Registering a Callback Handler

```go
dispatcher.AddHandler(handlers.NewCallback(
    callbackquery.Prefix("restrict"),
    myModule.restrictHandler,
))
```
```

**Keep the "All Callbacks" table and "Callbacks by Module" sections unchanged** ‚Äî the callback list itself is still accurate. The Overview counts (21 callbacks, 14 modules) are also correct per the canonical inventory.

**Do NOT change the individual callback handler/source entries** ‚Äî those are documentation of what exists, not how the codec works.
  </action>
  <verify>
    <automated>cd /Users/divkix/GitHub/Alita_Robot && grep -q "namespace|v1|url-encoded-fields" docs/src/content/docs/api-reference/callbacks.md && grep -q "callbackcodec.Encode" docs/src/content/docs/api-reference/callbacks.md && grep -q "Backward Compatibility" docs/src/content/docs/api-reference/callbacks.md && echo "PASS"</automated>
  </verify>
  <done>callbacks.md documents the versioned codec format with namespace|v1|url-encoded-fields specification. Encode/decode Go code example present. Backward compatibility note for legacy dot-notation included. Old `{prefix}{data}` format and dot-notation examples removed. Callback list table unchanged.</done>
</task>

</tasks>

<verification>
1. `grep -c "/start" docs/src/content/docs/api-reference/commands.md` ‚Äî returns 2+ (in module table + alphabetical index)
2. `grep -c "Alias of" docs/src/content/docs/api-reference/commands.md` ‚Äî returns 4+ (one per alias pair minimum)
3. `grep "142" docs/src/content/docs/api-reference/commands.md` ‚Äî total command count present
4. `grep "namespace|v1" docs/src/content/docs/api-reference/callbacks.md` ‚Äî versioned format documented
5. `grep -v "prefix.*data" docs/src/content/docs/api-reference/callbacks.md` ‚Äî old format removed from explanation
6. `cd /Users/divkix/GitHub/Alita_Robot/docs && bun run build 2>&1 | tail -5` ‚Äî build passes
</verification>

<success_criteria>
- commands.md contains exactly 142 commands (verified against INVENTORY.json)
- All 13 previously missing commands are documented with correct descriptions and permissions
- Every MultiCommand alias has its own row with "Alias of /primary" notation
- Permission column accurately reflects handler guard patterns for every command
- Exactly 17 commands are marked disableable
- All descriptions use terse functional tone (action-oriented, under ~60 chars)
- callbacks.md documents versioned codec format with code example
- Old dot-notation format replaced with backward-compatibility note
- Docs site builds with no broken links
</success_criteria>

<output>
After completion, create `.planning/phases/02-api-reference-and-command-documentation/02-02-SUMMARY.md`
</output>
