# Multi-stage build for production Docker images
# Uses cross-compilation to avoid QEMU emulation issues with Alpine on ARM64

# Stage 1: Build using native platform, cross-compile for target
FROM --platform=$BUILDPLATFORM golang:alpine AS builder

# Build arguments for cross-compilation
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app

# Copy go mod files first for better layer caching
COPY go.mod go.sum ./

# Download dependencies - runs on native platform, cached unless go.mod/go.sum change
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Copy source code
COPY . .

# Cross-compile the binary for target platform (no QEMU needed - Go handles this natively)
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build \
    -trimpath \
    -ldflags="-s -w" \
    -o alita_robot .

# Stage 2: Minimal runtime image
FROM gcr.io/distroless/static-debian12
USER 65532:65532
WORKDIR /app
COPY --from=builder /app/alita_robot /app/alita_robot
COPY --from=builder /app/migrations /app/migrations
EXPOSE 8080 8081
ENTRYPOINT ["/app/alita_robot"]

# Metadata
LABEL org.opencontainers.image.authors="Divanshu Chauhan <divkix@divkix.me>"
LABEL org.opencontainers.image.url="https://divkix.me"
LABEL org.opencontainers.image.source="https://github.com/divkix/Alita_Robot"
LABEL org.opencontainers.image.title="Alita Go Robot"
LABEL org.opencontainers.image.description="Official Alita Go Robot Docker Image"
LABEL org.opencontainers.image.vendor="Divkix"
