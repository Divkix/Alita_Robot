# Multi-stage build for PR Docker images
# Uses cross-compilation to avoid QEMU emulation issues with Alpine on ARM64

# Stage 1: Build using native platform, cross-compile for target
FROM --platform=$BUILDPLATFORM golang:alpine AS builder

# Build arguments
ARG PR_NUMBER=unknown
ARG COMMIT_SHA=unknown
ARG TARGETOS
ARG TARGETARCH

WORKDIR /app

# Copy go mod and sum files first for better caching
COPY go.mod go.sum ./

# Download dependencies - runs on native platform, cached
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    go mod download && go mod verify

# Copy source code
COPY . .

# Cross-compile the binary for target platform (no QEMU needed - Go handles this natively)
RUN --mount=type=cache,target=/go/pkg/mod \
    --mount=type=cache,target=/root/.cache/go-build \
    CGO_ENABLED=0 GOOS=${TARGETOS} GOARCH=${TARGETARCH} go build \
    -trimpath \
    -ldflags="-s -w -X main.version=pr-${PR_NUMBER} -X main.commit=${COMMIT_SHA}" \
    -o alita_robot .

# Stage 2: Minimal runtime image
FROM gcr.io/distroless/static-debian12:nonroot
WORKDIR /app
COPY --from=builder /app/alita_robot .
COPY supabase /app/supabase
USER nonroot
ENTRYPOINT ["./alita_robot"]

# Metadata
LABEL org.opencontainers.image.authors="Divanshu Chauhan <divkix@divkix.me>"
LABEL org.opencontainers.image.url="https://divkix.me"
LABEL org.opencontainers.image.source="https://github.com/divkix/Alita_Robot"
LABEL org.opencontainers.image.title="Alita Go Robot - PR Build"
LABEL org.opencontainers.image.description="Pull Request build of Alita Go Robot"
LABEL org.opencontainers.image.vendor="Divkix"
